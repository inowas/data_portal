{% extends 'app/layout.html' %}

{% block content %}

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <h3>Dataset: {{ dataset.name }}</h3>
        </div>
        <br>
    </div>
    <div class="row">
        <div class="col-sm-3">
            <div id="treeview"></div>
        </div>
        <div class="col-sm-7">
            <div class="row">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="map" class="map"></div>
                        <div id="popup" class="ol-popup">
                            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                            <div id="popup-content"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <a href="{% url 'create_model_object' dataset.id %}" class="btn btn-primary pull-left">Add new data object
                    <span class="glyphicon glyphicon-plus"></span>
                </a>
            </div>
        </div>
        <div class="col-sm-2">
            {% include 'app/card_dataset.html' %}
        </div>
    </div>        
</div>


{% endblock %}

{% block scripts %}
<script type="text/javascript">
    var container = document.getElementById('popup');
    var content_element = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
        element: container,
        autoPan: true,
        autoPanAnimation: {
        duration: 250
        }
    }));

    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    var map = new ol.Map({
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        target: 'map',
        overlays: [overlay],
        controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
                collapsible: false
            })
        }),
        view: new ol.View({
        center: [0, 0],
        zoom: 1
        })
    });
    
   
    var geojson_layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            url: '/api/geojson/' + "{{ dataset.id }}",
            format: new ol.format.GeoJSON()
        })
    });

    geojson_layer.getSource().on("change", function(evt) {
        extent = geojson_layer.getSource().getExtent();
        map.getView().fit(extent, map.getSize());
    });
    

    map.addLayer(geojson_layer)


    map.on('singleclick', function(evt) {
        var coordinate = evt.coordinate;
        var feature = map.forEachFeatureAtPixel(evt.pixel,
        function(feature, layer) {
            return feature;
        });
        if (feature) {
            var content = '<h5><strong>Name: </strong>'+ feature.get('name') + '</h5>';
            content += '<h5><strong>Type: </strong>'+ feature.get('object_type') + '</h5>';
            content += '<h5><strong>Dataset ID: </strong>'+ feature.get('dataset_id') + '</h5>';
            
            content_element.innerHTML = content;
            overlay.setPosition(coordinate);

        }
    });

</script>
    {% include 'app/data_tree_js.html' %}

{% endblock scripts %}